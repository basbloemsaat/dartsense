<!DOCTYPE html>
<html>

<head>
    <title>dir</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <style>
    td.speler1,
    th.speler1 {
        text-align: right;
    }

    .win {
        background-color: #efe;
    }

    .loss {
        background-color: #fee;
    }

    svg.chart {
        border: 1px solid yellow;
        width: 100%;
        height: 20em;
    }

    g.xaxis,
    g.yaxis {
        shape-rendering: crispEdges;
    }

    path.line {
        fill: none;
        stroke: black;
    }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h1 id="title">speler</h1>
        <div class="row">
            <div class="col-lg-6">
                <h2>punten</h2>
                <svg id="punten" class="chart"></svg>
            </div>
            <div class="col-lg-6">
                <h2>rating</h2>
                <svg id="rating" class="chart"></svg>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <h2>wedstrijden</h2>
                <table id="games" class="table">
                    <thead>
                        <th>datum</th>
                        <th class="speler1">speler</th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th>speler</th>
                        <th>elo rating</th>
                        <th>seizoen</th>
                    </thead>
                    <tbody> </tbody>
                </table>
            </div>
        </div>
    </div>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="./bbdataviz.js"></script>
    <script src="./dartsapp.js"></script>
    <script>
    var puntenchart;
    var ratingchart;
    let p = bbdataviz.url_params();
    let s = p['speler'];

    let draw_page = function() {
        let games = dartsapp.data.spelers[p['speler']]['games'];
        let max_season_points = games.reduce(function(a, b) {
            console.log(a,b)
            return Math.max(a.comp_punten || a || 0, b.comp_punten || b || 0);
        })
        let min_date = new Date(games.reduce(function(a, b) {
            return Math.min(a.timestamp || a, b.timestamp || b);
        }))
        let max_date = new Date(games.reduce(function(a, b) {
            return Math.max(a.timestamp || a, b.timestamp || b);
        }))
        games.sort(function(a, b) {
            return b.game_order - a.game_order
        })
        let gamerows = d3.select('table#games').select('tbody').selectAll('tr')
            .data(games, function(d) { return d.game_id });
        let newrows = gamerows.enter().append('tr')
            .classed('win', function(d) {
                return (
                    (d.speler1_naam == s && d.speler1_legs > d.speler2_legs) ||
                    (d.speler2_naam == s && d.speler2_legs > d.speler1_legs))

            })
            .classed('loss', function(d) {
                return (
                    (d.speler2_naam == s && d.speler1_legs > d.speler2_legs) ||
                    (d.speler1_naam == s && d.speler2_legs > d.speler1_legs))
            })

        newrows.append('td').text(function(d) { return d.datum })
        newrows.append('td')
            .classed('speler1', true)
            .text(function(d) { return d.speler1_naam })
        newrows.append('td').text(function(d) { return d.speler1_legs })
        newrows.append('td').text(' - ')
        newrows.append('td').text(function(d) { return d.speler2_legs })
        newrows.append('td').text(function(d) { return d.speler2_naam })
        newrows.append('td').text(function(d) { return d.speler_rating + ' (' + d.speler_rating_adj + ')' })
        newrows.append('td').text(function(d) { return d.comp })

        games.sort(function(a, b) {
            return a.game_order - b.game_order
        })

        {
            puntenchart = new bbdataviz.xyChart(d3.select('svg#punten'));
            let y_scale = d3.scaleLinear()
                .domain([0, max_season_points])
                .range([puntenchart.c_height, 0])
            puntenchart.y_axis.call(
                d3.axisLeft(y_scale)
            )

            let x_scale = d3.scaleTime()
                .domain([min_date, max_date])
                .range([0, puntenchart.c_width])

            puntenchart.x_axis.call(
                d3.axisBottom(x_scale.nice())
                .tickFormat(function(date) {
                    if (d3.timeYear(date) < date) {
                        return d3.timeFormat('%b')(date);
                    } else {
                        return d3.timeFormat('%Y')(date);
                    }
                })
            )

            let games_per_season = d3.nest()
                .key(function(d) { return d.comp })
                .entries(games)

            let line = d3.line()
                .curve(d3.curveStepAfter)
                .x(function(d) {
                    return x_scale(d.date)
                })
                .y(function(d) {
                    // console.log(d)
                    return y_scale(d.comp_punten)
                })

            let lines = puntenchart.content.selectAll('path.line')
                .data(games_per_season)
                .enter()
                .append('path')
                .classed('line', true)
                .attr("d", function(d) {
                    return line(d.values);
                });

            // lines.enter()


        }

        // ratingchart = new bbdataviz.xyChart(d3.select('svg#rating'));

    }

    dartsapp.load_data(draw_page, { 'spelers': [s], })
    </script>
</body>

</html>